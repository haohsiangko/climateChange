
<!doctype html>
<html>
<head>
    <meta charset="UTF-8">
    <script src="https://d3js.org/d3.v3.js"></script>    
    <style>
    </style>
    
    <title>Climate Change</title>
</head>
<body>
    <svg></svg>
    <script>
        //畫布
        var svg = d3.select("svg")
            .attr({
                x: 0,
                y: 0,
                width: 3000,
                height: 2000,
            })
            .style({
                background: "#eee"
        });
        
        //讀入資料
        d3.csv("test.csv", function(data){
            console.log(data);
            
            
            var titleY = 70;
            var moveDown = 70;
            var startX = 110;
            var startY = titleY + moveDown;
            var intervalW = 0;
            var intervalMonth = 10;
            var intervalH = 12; 
            var rWidth = 100;
            var rHeight = 5;
            var dy = 3;
            var color = d3.scale.linear().domain([1911,2018])
                          .interpolate(d3.interpolateHcl)
                          .range([d3.rgb("#ffd700"), d3.rgb('B8860B')]); //#FFEB3B, #1A237E
            
            var scaleX = d3.scale.linear()
                                    .domain([1,12])
                                    .range([startX + rWidth/2, startX + (intervalMonth + rWidth)*11 + rWidth/2]);
            
            var scaleY = d3.scale.linear()
                                    .domain([10,32])
                                    .range([startY +108*intervalH, startY + intervalH]);
            
            
            console.log(scaleX(0));
            console.log(scaleX(12));
            console.log(scaleY(10));
            console.log(scaleY(32));

            
            
            //Axis
            var xAxis = d3.svg.axis().scale(scaleX) //增加軸線物件，並套用尺度(x)
	                       .orient("bottom") //標示位置
	                       .ticks(12); //刻度數量
                           
            
            var yAxis = d3.svg.axis().scale(scaleY) //增加軸線物件，並套用尺度(y)
                .orient("left") //標示位置
                .ticks(10) //刻度數量
                .tickFormat(function(d) { return d+"°C"; });
            
            
            
            var h = 1450;
            var padding = 70;
            
            
//            var axisMonth = svg.append('g').attr('class', 'axis')
//                .attr('transform', 'translate(0, '+ (h - padding) +')') 
//                .call(xAxis); //將軸線匯入
            
            //溫度時間軸
            var axisTem = svg.append('g').attr('class', 'axis')
                .attr('transform', 'translate('+ (padding) +')', 0) 
                .call(yAxis);
            
            axisTem.attr({
                opacity: 0,
            }).transition().duration(1000).delay(25000).attr({
                opacity: 1,
            })
      
            
//            circles = svg.selectAll("circles").data(data).enter();
//            circles.append("circle")
//                    .attr({
//                        cx: function(d){return scaleX(d.month);},
//                        cy: function(d){return startY + d.index1*intervalH;},
//                        r: 5,
//                        fill: function(d){return color(d.year);},
//            }).transition().duration(5000).delay(3000)
//                    .attr({
//                        cx: function(d){return scaleX(d.month);},
//                        cy: function(d){return scaleY(d.tem);},
//                        r: 5,
//                        fill: function(d){return color(d.year);},
//            });
            

            
//            data.sort(function (a, b) {
//             return a.tem < b.tem ? 1 : -1;
//            });
//            
            
            
            
//原本要放代數
            
//            var fadeIn = 5000; //進場動畫時間
//            var fadeIn_s = 1000;
//            var fadeOut = 1000; //撤掉元素的時間
//            var still = 5000;
//            var still_s = 3000;
//            var endAxis = 1000; //撤銷舊座標軸預留幾秒
//            var addAxis = 1000;
//            
//            
//            
//            //rect的部分
//            var cut0 = 0; 
//            //停滯3s，全部集中，表示說這是年份
//            var cut1 = cut0 + still_s;  //rect啟動
//            //發牌到各個月份，發5s 
//            
//            動畫結束前2秒啟動座標（出現年份）
//            
//            
//            var cut2 = cut1 + fadeIn; // 動畫結束時間
//            //靜止5s 
//            var cut3 = cut2 + still; //rect啟動
//            //移動成排名5s 
//            
//            舊座標（年份）消失
//            動畫結束前2秒啟動座標（出現排名）
//            
//            var cut4 = cut3 + fadeIn; //動畫結束時間
//            //靜止5s
//            var cut5 = cut4 + still; //rect啟動
//            //移動到溫度位置5s 
//            
//            舊座標（排名）消失
//            動畫結束前啟動座標（出現溫度）
//            
//            var cut6 = cut5 + fadeIn; //動畫結束時間
//            //靜止3s
//            var cut7 = cut6 + still_s; //rect啟動、 舊顏色消失
//            //2s 變色，label指出冠軍 
//                        
//            
//            var cut8 = cut7 + fadeIn_s; //動畫結束時間
//            //停留5s
//            var cut9 = cut8 + still; //rect啟動
//            //秀出平均 還有2000年以後，展示5s 
//            
//            
//            var cut10 = cut9 + fadeIn_s;  //動畫結束時間
//            //收斂回初始狀態5s 
//            
//            
//        
            

            
            //binding
            rects = d3.select("svg").selectAll("rects").data(data).enter();
            rects.append("rect")
                .attr({
                       rx: 0,
                        ry: 0,
                        x: function(d){return scaleX(7)},
                        y: function(d){return startY + d.index1*(intervalH);},
                        width: rWidth/2,
                        height: rHeight,
                        fill: function(d){return color(d.year);},
            })
                .transition().duration(5000).delay(3000) //發牌，跑到各年月位置
                    .attr({
                        rx: 0,
                        ry: 0,
                        x: function(d){return startX + (intervalMonth+rWidth)*(d.month-1);},
                        y: function(d){return startY + d.index1*intervalH;},
                        width: rWidth,
                        height: rHeight,
                        fill: function(d){return color(d.year);}
                })
                .transition().duration(5000).delay(11000) //跑到排名定位
                    .attr({
                        rx: 0,
                        ry: 0,
                        x: function(d){return startX + (intervalMonth+rWidth)*(d.month-1) + 
                                              d.index3*(rWidth/d.sameRank);},
                        y: function(d){return startY + d.index2*intervalH;},
                        width: function(d){return rWidth/d.sameRank-5;},
                })
                .transition().duration(5000).delay(21000) //跑到溫度定位
                    .attr({
                        rx: 10,
                        ry: 10,
                        x: function(d){return scaleX(d.month);},
                        y: function(d){return scaleY(d.tem);},
                        width: 10,
                        height: 10,
                        opacity: 1,
                })
                .transition().duration(1000).delay(29000) //凸顯出冠軍
                    .attr({
                        fill: function(d){
                            if(+d.index2===1){
                                return color(d.year);
                               }else{
                                return "#ccc";
                               }
                        },
                        opacity: function(d){
                            if(+d.index2===1){
                                return 1;
                               }else{
                                return 0.3;
                               }
                        },
                })
                .transition().duration(1000).delay(34000) //秀出2000以後的資料
                    .attr({
                        fill: function(d){
                            if(+d.year>=2000){
                                return color(d.year);
                               }else{
                                return "#ccc";
                               }
                        },
                        opacity: function(d){
                            if(+d.year>=2000){
                                return 1;
                               }else{
                                return 0.3;
                               }
                        },
                })
                
    
//                .transition().duration(5000).delay(13000)
//                    .attr({
//                        x: function(d){return startX + (intervalMonth+rWidth)*(d.month-1);},
//                        y: function(d){return startY + d.index1*intervalH;},
//                        width: rWidth,
//                        height: rHeight,
//                        fill: function(d){return color(d.year);}
//                })
                
            ;
            
            //月份
            months = ['1','2','3','4','5','6',"7","8","9","10","11","12"];
            monT = d3.select("svg").selectAll(".months").data(months).enter();
            monT.append("text")
                    .attr("class","months")
                    .attr({
                        x: function(d,i){return scaleX(+d) ;}, //startX + (intervalMonth+rWidth)*i+rWidth/4
                        y: titleY + moveDown - 15,
                        fill: "black",
                        "font-size": "30px",
                        opacity: 0,
                        "text-anchor": "middle",
            }).text(function(d){return d+"月";}).transition().duration(1000).delay(7000).attr({
                opacity: 1,
            });
            
            
            //年份y軸
            
            years = [1911, 1920, 1930, 1940, 1950, 1960, 1970, 1980, 1990, 2000, 2010, 2018]
            
            yearT = d3.select("svg").selectAll(".years").data(years).enter();
            yearT.append("text")
                    .attr("class","years")
                    .attr({
                        x: function(d){return scaleX(7)-rWidth;},
                        y: function(d){return startY + (d-1911+1)*(intervalH) + rHeight +dy;},
                        fill: "black",
                        "font-size": "25px",
                        opacity: 1,
            }).text(function(d){return d+"年-";})
                .transition().duration(5000).delay(3000)
                    .attr({
                        x: 10,
            })
                .transition().duration(1000).delay(11000)
                    .attr({
                       
                        opacity: 0,
            })
            ;

            
            
            
            
            
            
            
            
            //排名y軸
            
            ranks = [1, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 108];
            
            rankT = d3.select("svg").selectAll(".ranks").data(ranks).enter();
            
            rankT.append("text")
                    .attr("class","ranks")
                    .attr({
                        x: 10,
                        y: function(d){return startY + d*(intervalH) + rHeight +dy;},
                        fill: "black",
                        "font-size": "25px",
                        opacity: 0,
            }).text(function(d){return "第"+d+"名-";})
                .transition().duration(1000).delay(15000)
                    .attr({
                        fill: "black",
                        opacity: 1,
            }).transition().duration(1000).delay(21000)
                    .attr({
                        fill: "black",
                        opacity: 0,
            })
            ;
            
            
            
            
            
            
            
            
            
            
            
            //LABEL 該月最高溫在哪一年
            
            labels = data.filter(function(d){return +d.index2 ===1;});
            
            console.log(labels);
            
            highest = d3.nest().key(function(d){return d.month;}).entries(labels);
            console.log(highest);
            
            
            labelT = svg.selectAll(".highest").data(highest).enter();
            
            labelT.append("text")
                    .attr("class", "highest")
                    .attr({
                        x: function(d){return scaleX(+d.key);},
                        y: function(d){return scaleY(+d.values[0].tem)-10},
                        fill: "black",
                        "font-size": "25px",
                        opacity: 0,
                
            }).text(function(d){ 
                if(d.values.length>1){
                    var t = []
                    for(var i=0; i<d.values.length; i++){
                        t.push(d.values[i].year);
                    }
                     return t.toString()+"年";
                   }else{
                     return d.values[0].year.toString()+"年";}
                   }
                )
                .transition().duration(1000).delay(29000)
                .attr({
                    opacity: 1,    
            }).transition().duration(1000).delay(34000)
                .attr({
                    opacity: 0,    
            })
            
            ;
            
            
            
            //LABEL2  該月最高溫是幾度
            
            labelT2 = svg.selectAll(".highest2").data(highest).enter();
            
            labelT2.append("text")
                    .attr("class", "highest2")
                    .attr({
                        x: function(d){return scaleX(+d.key);},
                        y: function(d){return scaleY(+d.values[0].tem)+40},
                        fill: "black",
                        "font-size": "25px",
                        opacity: 0,
                
            }).text(function(d){ 
                        return d.values[0].tem +"°C";
                   }
                )
                .transition().duration(1000).delay(29000)
                .attr({
                    opacity: 1,    
            }).transition().duration(1000).delay(34000)
                .attr({
                    opacity: 0,    
            })
            
            ;
            
            
            
            
            //歷史均溫
            historyAvg = [15.48,15.78,17.76,21.42,24.76,27.15,28.91,28.66,27.03,23.74,20.76,17.39];
            
            
            
            
            var line = d3.svg.line().interpolate('basis')
                        .x(function(d,i) {
                            return scaleX(i + 1); //利用尺度運算資料索引，傳回x的位置
                        })
                        .y(function(d) {
                            return scaleY(d); //利用尺度運算資料的值，傳回y的位置
                        });

            svg.append('path').attr('d', line(historyAvg)).attr({
                fill: "rgba(0,0,0,0)",
                stroke: "black",
                "stroke-width": "3px",
                opacity: 0,
            }).transition().duration(1000).delay(35000).attr({
               opacity:1 
            });

            
            //各段標題
            titles = [
                "1911-2018年各月月均溫數據（台北站）",
                "按高溫紀錄排名，可發現近年數據排名較前",
                "氣溫高低分布",
                "最高月均溫發生年份",
                "2000年後數據多大於氣候平均值（想確認切哪一年合適？）",
            ]
            
            //標題的位置
            svg.append("text").attr({
                x: 10,
                y: titleY,
                "font-size": "50px",
                fill: "black",
                "font-weight": 900,
                opacity: 0,
            }).text(titles[0])
                .transition().duration(1000).delay(7000).attr({opacity: 1,})
                .transition().duration(1000).delay(11000).attr({opacity: 0})
                .transition().duration(1000).delay(15000).text(titles[1]).attr({opacity: 1})
                .transition().duration(1000).delay(21000).attr({opacity: 0})
                .transition().duration(1000).delay(25000).text(titles[2]).attr({opacity: 1})
                .transition().duration(1000).delay(28000).attr({opacity: 0})
                .transition().duration(1000).delay(29000).text(titles[3]).attr({opacity: 1})
                .transition().duration(1000).delay(34000).attr({opacity: 0})
                .transition().duration(1000).delay(35000).text(titles[4]).attr({opacity: 1})
            ;
            
            
      
        })   //csv






    </script>

</body>
</html>